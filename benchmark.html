<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPFS-FS Browser Benchmark</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .benchmark {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .benchmark:last-child { border-bottom: none; }
    .benchmark-name { font-weight: 500; }
    .benchmark-result {
      font-family: monospace;
      padding: 4px 12px;
      border-radius: 4px;
      background: #e8f5e9;
      color: #2e7d32;
    }
    .benchmark-result.pending {
      background: #fff3e0;
      color: #ef6c00;
    }
    .benchmark-result.error {
      background: #ffebee;
      color: #c62828;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #1565c0; }
    button:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }
    #log {
      font-family: monospace;
      font-size: 12px;
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .summary {
      font-size: 18px;
      font-weight: bold;
      color: #1976d2;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>OPFS-FS Browser Benchmark</h1>

  <div class="card">
    <p>This benchmark tests real OPFS performance in your browser. Results may vary based on browser and system.</p>
    <button id="runAll" onclick="runAllBenchmarks()">Run All Benchmarks</button>
    <button onclick="clearOPFS()">Clear OPFS Storage</button>
  </div>

  <div class="card">
    <h3>Read/Write Performance</h3>
    <div class="benchmark">
      <span class="benchmark-name">100 small file writes (1KB each)</span>
      <span class="benchmark-result pending" id="small-writes">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">100 small file reads</span>
      <span class="benchmark-result pending" id="small-reads">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">1MB file write</span>
      <span class="benchmark-result pending" id="large-write">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">1MB file read</span>
      <span class="benchmark-result pending" id="large-read">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">10MB file streaming read (64KB chunks)</span>
      <span class="benchmark-result pending" id="stream-read">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">100 batch writes (writeFileBatch)</span>
      <span class="benchmark-result pending" id="batch-writes">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">100 batch reads (readFileBatch)</span>
      <span class="benchmark-result pending" id="batch-reads">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">100 repeated reads (pooled handles)</span>
      <span class="benchmark-result pending" id="pooled-reads">--</span>
    </div>
  </div>

  <div class="card">
    <h3>Directory Operations</h3>
    <div class="benchmark">
      <span class="benchmark-name">Create 50 nested directories</span>
      <span class="benchmark-result pending" id="mkdir">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">List directory with 200 files</span>
      <span class="benchmark-result pending" id="readdir">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">Copy 20 files recursively</span>
      <span class="benchmark-result pending" id="copy">--</span>
    </div>
  </div>

  <div class="card">
    <h3>Symlink Operations</h3>
    <div class="benchmark">
      <span class="benchmark-name">Create 50 symlinks (batch)</span>
      <span class="benchmark-result pending" id="symlink-batch">--</span>
    </div>
    <div class="benchmark">
      <span class="benchmark-name">100 reads through 5-link chain</span>
      <span class="benchmark-result pending" id="symlink-chain">--</span>
    </div>
  </div>

  <div class="card">
    <h3>Filesystem Info</h3>
    <div class="benchmark">
      <span class="benchmark-name">100 statfs() calls</span>
      <span class="benchmark-result pending" id="statfs">--</span>
    </div>
  </div>

  <div class="card">
    <h3>Console Log</h3>
    <div id="log"></div>
    <div class="summary" id="summary"></div>
  </div>

  <script type="module">
    // Import OPFS from dist
    import OPFS from './dist/index.js';

    const fs = new OPFS({ useSync: true, verbose: false });
    let results = {};

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
      console.log(msg);
    }

    function setResult(id, time, error = false) {
      const el = document.getElementById(id);
      el.className = 'benchmark-result' + (error ? ' error' : '');
      el.textContent = error ? 'Error' : time.toFixed(2) + 'ms';
      if (!error) results[id] = time;
    }

    async function clearOPFS() {
      log('Clearing OPFS storage...');
      try {
        await fs.rmdir('/');
        log('OPFS storage cleared');
      } catch (e) {
        log('Clear error: ' + e.message);
      }
    }

    async function runBenchmark(name, id, fn) {
      log(`\nRunning: ${name}`);
      try {
        const start = performance.now();
        await fn();
        const duration = performance.now() - start;
        log(`  Completed in ${duration.toFixed(2)}ms`);
        setResult(id, duration);
        return duration;
      } catch (e) {
        log(`  Error: ${e.message}`);
        setResult(id, 0, true);
        return -1;
      }
    }

    window.runAllBenchmarks = async function() {
      const btn = document.getElementById('runAll');
      btn.disabled = true;
      btn.textContent = 'Running...';
      document.getElementById('log').textContent = '';
      document.getElementById('summary').textContent = '';
      results = {};

      log('Starting OPFS-FS Browser Benchmarks');
      log('==================================');

      // Clear first
      await clearOPFS();

      // Small file writes
      await runBenchmark('100 small file writes', 'small-writes', async () => {
        for (let i = 0; i < 100; i++) {
          await fs.writeFile(`/bench/file${i}.txt`, 'x'.repeat(1024));
        }
      });

      // Small file reads
      await runBenchmark('100 small file reads', 'small-reads', async () => {
        for (let i = 0; i < 100; i++) {
          await fs.readFile(`/bench/file${i}.txt`);
        }
      });

      // Large file write
      const largeData = new Uint8Array(1024 * 1024);
      for (let i = 0; i < largeData.length; i++) largeData[i] = i % 256;

      await runBenchmark('1MB file write', 'large-write', async () => {
        await fs.writeFile('/bench/large.bin', largeData);
      });

      // Large file read
      await runBenchmark('1MB file read', 'large-read', async () => {
        await fs.readFile('/bench/large.bin');
      });

      // Stream read (10MB)
      const hugeData = new Uint8Array(10 * 1024 * 1024);
      await fs.writeFile('/bench/huge.bin', hugeData);

      await runBenchmark('10MB file streaming read', 'stream-read', async () => {
        const stream = fs.createReadStream('/bench/huge.bin');
        const reader = stream.getReader();
        let totalBytes = 0;
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          totalBytes += value.length;
        }
      });

      // Batch writes - uses writeFileBatch for optimal performance
      const batchEntries = [];
      for (let i = 0; i < 100; i++) {
        batchEntries.push({ path: `/bench/batch/file${i}.txt`, data: `batch content ${i}` });
      }

      await runBenchmark('100 batch writes (writeFileBatch)', 'batch-writes', async () => {
        await fs.writeFileBatch(batchEntries);
      });

      // Batch reads - uses readFileBatch for optimal performance
      const batchReadPaths = batchEntries.map(e => e.path);

      await runBenchmark('100 batch reads (readFileBatch)', 'batch-reads', async () => {
        await fs.readFileBatch(batchReadPaths);
      });

      // Pooled reads - tests file handle pooling
      await fs.writeFile('/bench/pooled.txt', 'pooled content for repeated reads');

      await runBenchmark('100 repeated reads (pooled handles)', 'pooled-reads', async () => {
        for (let i = 0; i < 100; i++) {
          await fs.readFile('/bench/pooled.txt', { encoding: 'utf-8' });
        }
      });

      // Nested directories
      await runBenchmark('Create 50 nested directories', 'mkdir', async () => {
        for (let i = 0; i < 50; i++) {
          await fs.mkdir(`/bench/dirs/d${i}/sub/deep`);
        }
      });

      // Large directory listing
      await fs.mkdir('/bench/many');
      for (let i = 0; i < 200; i++) {
        await fs.writeFile(`/bench/many/f${i}.txt`, 'x');
      }

      await runBenchmark('List directory with 200 files', 'readdir', async () => {
        await fs.readdir('/bench/many');
      });

      // Copy files
      await fs.mkdir('/bench/src');
      for (let i = 0; i < 20; i++) {
        await fs.writeFile(`/bench/src/f${i}.txt`, `content ${i}`);
      }

      await runBenchmark('Copy 20 files recursively', 'copy', async () => {
        await fs.cp('/bench/src', '/bench/dst', { recursive: true });
      });

      // Symlink batch
      const symlinks = [];
      for (let i = 0; i < 50; i++) {
        symlinks.push({ target: `/bench/file${i % 100}.txt`, path: `/bench/links/link${i}` });
      }

      await runBenchmark('Create 50 symlinks (batch)', 'symlink-batch', async () => {
        await fs.symlinkBatch(symlinks);
      });

      // Symlink chain
      await fs.writeFile('/bench/chain-target.txt', 'chain data');
      await fs.symlink('/bench/chain-target.txt', '/bench/chain1');
      await fs.symlink('/bench/chain1', '/bench/chain2');
      await fs.symlink('/bench/chain2', '/bench/chain3');
      await fs.symlink('/bench/chain3', '/bench/chain4');
      await fs.symlink('/bench/chain4', '/bench/chain5');

      await runBenchmark('100 reads through 5-link chain', 'symlink-chain', async () => {
        for (let i = 0; i < 100; i++) {
          await fs.readFile('/bench/chain5', { encoding: 'utf-8' });
        }
      });

      // Statfs
      await runBenchmark('100 statfs() calls', 'statfs', async () => {
        for (let i = 0; i < 100; i++) {
          await fs.statfs();
        }
      });

      // Summary
      log('\n==================================');
      log('Benchmark Complete!');

      const total = Object.values(results).reduce((a, b) => a + b, 0);
      document.getElementById('summary').textContent = `Total time: ${total.toFixed(2)}ms`;

      btn.disabled = false;
      btn.textContent = 'Run All Benchmarks';
    };

    window.clearOPFS = clearOPFS;

    // Check OPFS support
    if (!navigator.storage?.getDirectory) {
      log('ERROR: OPFS is not supported in this browser!');
      document.getElementById('runAll').disabled = true;
    } else {
      log('OPFS is supported. Click "Run All Benchmarks" to start.');
    }
  </script>
</body>
</html>
